!function(t,e,i){function r(t,e,i,r){this.name=t,this.dependents=e,this.stores=i,this.datas=r,this.safe=!1}function n(t,e,i,r){this.app=t,this.name=e,this.store=i,this.data=r,this.migrateRemovePending=!1}function s(t,e,i){var r={name:t,dependencies:e,migrate:i};y[t]=M.length,M.push(r)}function a(){y={},M.length=0}function o(){x.push(Array.prototype.slice.call(arguments))}var d=e.Model,g=e.Collection,l=e.Promise,h=e.Events,f=e.isArray,u=e.isObject,m=e.toArray,c=e.isFunction,v=(e.isEmpty,e.copy),p=e.noop,w=e.indexOf,T=e.propsMatch;r.prototype={create:function(t,i){this.requireNotExists(t);var r=this.datas[t]=new g(i());e.migrationTest&&o("new store "+t+" created  ("+r.length+" records)",r)},drop:function(t){this.requireExists(t);var i=this.datas[t];i&&(e.migrationTest&&o("store "+t+" dropped ("+i.length+" records)",i.slice()),i.clear())},rename:function(t,i){this.requireExists(t),this.requireNotExists(i);var r=this.datas[t];r&&(this.datas[i]=r,this.datas[t]=new g,e.migrationTest&&o("store "+t+" renamed to "+i+" ("+r.length+" records)",r))},moveRelatedOut:function(t,i,r){this.requireExists(t),this.requireNotExists(r);var n=this.datas[t],s=this.datas[r];if(n&&s){for(var a=0;a<n.length;a++){var d=n[a],g=d[i];f(g)?s.addAll(g):u(g)&&s.add(g),delete d[i]}e.migrationTest&&o("store "+r+" populated from the records located in the "+i+" property of the "+t+" store ("+s.length+" records)",s)}},moveRelatedIn:function(t,i,r,n,s,a){this.requireExists(t),this.requireExists(r);var d=this.datas[t],g=this.datas[r],l=0;if(d&&g){for(var h=0;h<g.length;h++){var f=g[h],u=d.where(function(t){return T(t,i,f,n)});f[s]=a?u:u[0],l+=u.length}e.migrationTest&&o("store "+t+" moved into "+r+" to property "+s+" ("+l+" matched, "+(d.length-l)+" unmatched)",d.slice()),d.clear()}},migrate:function(t,i){if(this.requireExists(t),t in this.stores){var r=new n(this,t,this.stores[t],this.datas[t]);e.migrationTest&&o("store "+t+" migration start",r);var s=i.call(r,r);return e.migrationTest&&o("store "+t+" migration end",r),s}},newRecord:function(t,e){return t.$saved=v(t),t.$status=e||d.Status.Synced,t},requireExists:function(t){if(e.migrationTest&&o("ensuring store for "+t+" exists in "+(this.safe?"safe":"strict")+" mode",w(this.dependents,t)!==!1),!this.safe&&w(this.dependents,t)===!1)throw"A migration for "+t+" was attempted but did not exist in the dependencies array"},requireNotExists:function(t){if(e.migrationTest&&o("ensuring store for "+t+" does not exist yet in "+(this.safe?"safe":"strict")+" mode",w(this.dependents,t)!==!1&&0===this.datas[t].length),!this.safe){if(w(this.dependents,t)===!1)throw"A creation migration for "+t+" was attempted but did not exist in the dependencies array";if(0!==this.datas[t].length)throw"A creation migration for "+t+" was attempted but existing data was found"}}},n.prototype={drop:function(t){var i=m(t);return e.migrationTest&&o("dropping fields",i),this.transform(function(t){for(var e=0;e<i.length;e++)this.removeField(t,i[e])})},add:function(t,i){return c(i)?(e.migrationTest&&o("adding new field with dynamic default value: "+i),this.transform(function(e){this.setField(e,t,i(e))})):(e.migrationTest&&o("adding new field with constant default value",i),this.transform(function(e){this.setField(e,t,v(i))}))},rename:function(t,i){return e.migrationTest&&o("renaming field from "+t+" to "+i),this.transform(function(e){this.setField(e,i,e[t]),this.removeField(e,t)})},convert:function(t,i){return e.migrationTest&&o("converting field "+t+": "+i),this.transform(function(e){this.setField(e,t,i(e[t],e))})},filter:function(t){return e.migrationTest&&o("filtering records: "+t),this.transform(function(e){return!!t(e)})},setField:function(t,i,r){e.migrationTest&&(t.$saved?o("set field "+i+" to "+r+" where saved value was "+t.$saved[i]+" and stored value was "+t[i],t):o("set field "+i+" to "+r+" where stored value was "+t[i],t)),t.$saved&&(t.$saved[i]=r),t[i]=r},removeField:function(t,i){e.migrationTest&&(t.$saved?o("remove field "+i+" where saved value was "+t.$saved[i]+" and stored value was "+t[i],t):o("remove field "+i+" where stored value was "+t[i],t)),t.$saved&&delete t.$saved[i],delete t[i]},transform:function(t){var i=this.data;e.migrationTest&&o("running transform: "+t);for(var r=0;r<i.length;r++){var n=i[r];if(this.migrateRemovePending||n.$status!==d.Status.RemovePending){var s=t.call(this,n);s===!1&&(e.migrationTest&&o("removing record",n),i.splice(r--,1))}}return this}},e.load=function(i,n){function s(t){e.trigger(h.MigrationsLoaded,[t]),e.migrationTest&&o("migrations loaded",t),$=t;for(var i=0;i<t.length;i++)delete y[t[i]];e.migrationTest&&o("migrations being ran",y);for(var r in y)for(var n=M[y[r]],s=n.dependencies,d=0;d<s.length;d++)A[s[d]]=!0;for(var l in A)l in e.classes?R[l]=e.classes[l].Database.store:R[l]=e.store({name:l}),b[l]=new g,N++;for(var l in R){var f=a(l);R[l].all(f,f)}}function a(t){return function(i){f(i)&&b[t].reset(i),e.migrationTest&&o("store loaded",b[t]),++S===N&&d()}}function d(){for(var i=0;i<M.length;i++){var n=M[i];if(n.name in y){var s=new r(n.name,n.dependencies,R,b);e.migrationTest&&o("running migration "+n.name,s),n.migrate(s,b),e.trigger(h.MigrationRan,[n.name,s])}}if(e.migrationTest){var a=t.console;if(a&&a.log)for(var d=a.log,g=Function.prototype.call,i=0;i<x.length;i++)x[i].unshift(a),g.apply(d,x[i]);e.trigger(h.MigrationsTested,[x]),c()}else{for(var l in R){var f=R[l],m=b[l],v=[],w=e.classes[l];if(w){for(var T=w.Database,F=0;F<m.length;F++)v[F]=T.buildKeyFromInput(m[F]);f.reset(v,m,u,u)}else 0===m.length?f.reset(v,m,u,u):(e.trigger(h.MigrationClassNotFound,[l,f,m]),u())}for(var E in y)q.put(E,E,p,p);e.trigger(h.MigrationsSaved,[y])}}function u(){++P===N&&(e.trigger(h.MigrationsFinished,[]),c())}function m(){e.trigger(h.MigrationsNotLoaded,[]),c()}function c(){for(var t=0;t<T.length;t++)T[t].loadBegin(v)}function v(t,e){if(E.push(t),F.push(e),F.length===T.length){for(var i=0;i<F.length;i++){var e=F[i],t=E[i];t&&e.loadFinish()}w.reset().resolve()}}var w=e.loadPromise=e.loadPromise||new l(null,!1),T=e.unloaded.slice(),F=[],E=[];w.success(i,n||this),e.unloaded.length=0;var q=e.store({name:e.migrationStore}),$=[],R={},b={},A={},N=0,S=0,P=0;return q.all(s,m),w};var M=[],y={},x=[];h.MigrationsLoaded="migrations-loaded",h.MigrationRan="migration-ran",h.MigrationClassNotFound="migration-class-not-found",h.MigrationsSaved="migrations-saved",h.MigrationsTested="migrations-tested",h.MigrationsNotLoaded="migrations-not-loaded",h.MigrationsFinished="migrations-finished",e.migrationTest=!1,e.migrationStore="migrations",e.migration=s,e.migrationsClear=a,e.migrationLogs=x,e.Migrations=M,e.ApplicationMigrator=r,e.ModelMigrator=n}(this,Rekord);
//# sourceMappingURL=rekord-migrations.min.js.map
