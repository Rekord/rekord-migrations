!function(t,i,e){function n(t,i,e,n){this.name=t,this.dependents=i,this.stores=e,this.datas=n,this.safe=!1}function r(t,i,e,n){this.app=t,this.name=i,this.store=e,this.data=n,this.migrateRemovePending=!1}function s(t,i,e){var n={name:t,dependencies:i,migrate:e};M[t]=p.length,p.push(n)}function o(){M={},p.length=0}var a=i.Model,d=i.Collection,f=i.Promise,h=i.Events,u=i.isArray,g=i.toArray,l=i.isFunction,c=(i.isEmpty,i.copy),m=i.noop,v=i.indexOf;n.prototype={create:function(t,i){this.requireNotExists(t),this.datas[t]=new d(i())},drop:function(t){this.requireExists(t),t in this.datas&&this.datas[t].clear()},rename:function(t,i){this.requireExists(t),this.requireNotExists(i),t in this.datas&&(this.datas[i]=this.datas[t],this.datas[t]=new d)},migrate:function(t,i){return this.requireExists(t),t in this.stores?i(new r(this,t,this.stores[t],this.datas[t])):void 0},newRecord:function(t,i){return t.$saved=c(t),t.$status=i||a.Status.Synced,t},requireExists:function(t){if(!this.safe){if(v(this.dependents,t)===!1)throw"A migration for "+t+" was attempted but did not exist in the dependencies array";if(!(t in this.stores))throw"A migration for "+t+" was attempted but does not exist locally (or was not defined)"}},requireNotExists:function(t){if(!this.safe&&v(this.dependents,t)===!1)throw"A creation migration for "+t+" was attempted but did not exist in the dependencies array"}},r.prototype={drop:function(t){var i=g(t);return this.transform(function(t){for(var e=0;e<i.length;e++)this.removeField(t,i[e])})},add:function(t,i){return l(i)?this.transform(function(e){this.setField(e,t,i(e))}):this.transform(function(e){this.setField(e,t,c(i))})},rename:function(t,i){return this.transform(function(e){this.setField(e,i,e[t]),this.removeField(e,t)})},convert:function(t,i){return this.transform(function(e){this.setField(e,t,i(e[t],e))})},filter:function(t){return this.transform(function(i){return!!t(i)})},setField:function(t,i,e){t.$saved&&(t.$saved[i]=e),t[i]=e},removeField:function(t,i){t.$saved&&delete t.$saved[i],delete t[i]},transform:function(t){for(var i=this.data,e=0;e<i.length;e++){var n=i[e];if(this.migrateRemovePending||n.$status!==a.Status.RemovePending){var r=t.call(this,n);r===!1&&i.splice(e--,1)}}return this}},i.load=function(e,r){function s(t){i.trigger(h.MigrationsLoaded,[t]),N=t;for(var e=0;e<t.length;e++)delete M[t[e]];for(var n in M)for(var r=p[M[n]],s=r.dependencies,a=0;a<s.length;a++)$[s[a]]=!0;for(var f in $)f in i.classes?R[f]=i.classes[f].Database.store:R[f]=i.store({name:f}),S[f]=new d,b++;for(var f in R){var u=o(f);R[f].all(u,u)}}function o(t){return function(i){u(i)&&S[t].reset(i),++A===b&&a()}}function a(){for(var e=0;e<p.length;e++){var r=p[e];if(r.name in M){var s=new n(r.name,r.dependencies,R,S);r.migrate(s,S),i.trigger(h.MigrationRan,[r.name,s])}}if(i.migrationTest)t.console&&t.console.log&&t.console.log(F),i.trigger(h.MigrationsTested,[F]);else{for(var o in R){var a=R[o],d=S[o],f=[],u=i.classes[o];if(u){for(var l=u.Database,c=0;c<d.length;c++)f[c]=l.buildKeyFromInput(d[c]);a.reset(f,d,g,g)}else 0===d.length?a.reset(f,d,g,g):(i.trigger(h.MigrationClassNotFound,[o,a,d]),g())}for(var v in M)q.put(v,v,m,m);i.trigger(h.MigrationsSaved,[M])}}function g(){++P===b&&(i.trigger(h.MigrationsFinished,[]),c())}function l(){i.trigger(h.MigrationsNotLoaded,[]),c()}function c(){for(var t=0;t<x.length;t++)x[t].loadBegin(v)}function v(t,i){if(E.push(t),y.push(i),y.length===x.length){for(var e=0;e<y.length;e++){var i=y[e],t=E[e];t&&i.loadFinish()}w.reset().resolve()}}var w=i.loadPromise=i.loadPromise||new f(null,!1),x=i.unloaded.slice(),y=[],E=[];w.success(e,r||this),i.unloaded.length=0;var q=i.store({name:i.migrationStore}),N=[],R={},S={},$={},b=0,A=0,P=0;return q.all(s,l),w};var p=[],M={},F=[];h.MigrationsLoaded="migrations-loaded",h.MigrationRan="migration-ran",h.MigrationClassNotFound="migration-class-not-found",h.MigrationsSaved="migrations-saved",h.MigrationsTested="migrations-tested",h.MigrationsNotLoaded="migrations-not-loaded",h.MigrationsFinished="migrations-finished",i.migrationTest=!1,i.migrationStore="migrations",i.migration=s,i.migrationsClear=o,i.Migrations=p,i.ApplicationMigrator=n,i.ModelMigrator=r}(this,Rekord);
//# sourceMappingURL=rekord-migrations.min.js.map
