!function(t,e,i){function r(t,e,i,r){this.name=t,this.dependents=e,this.stores=i,this.datas=r,this.safe=!1}function n(t,e,i,r){this.app=t,this.name=e,this.store=i,this.data=r,this.migrateRemovePending=!1}function s(t,e,i){var r={name:t,dependencies:e,migrate:i};y[t]=M.length,M.push(r)}function a(){y={},M.length=0}function o(){x.push(Array.prototype.slice.call(arguments))}var d=e.Model,g=e.Collection,l=e.Promise,f=e.Events,h=e.isArray,u=e.isObject,m=e.toArray,c=e.isFunction,v=(e.isEmpty,e.copy),p=e.noop,w=e.indexOf,T=e.propsMatch;r.prototype={create:function(t,i){var r=this.requireNotExists(t);if(r){var n=this.datas[t]=new g(i());e.migrationTest&&o("new store "+t+" created  ("+n.length+" records)",n)}},drop:function(t){var i=this.requireExists(t);if(i){var r=this.datas[t];e.migrationTest&&o("store "+t+" dropped ("+r.length+" records)",r.slice()),r.clear()}},rename:function(t,i){var r=this.requireExists(t)&&this.requireNotExists(i);if(r){var n=this.datas[t];this.datas[i]=n,this.datas[t]=new g,e.migrationTest&&o("store "+t+" renamed to "+i+" ("+n.length+" records)",n)}},moveRelatedOut:function(t,i,r){var n=this.requireExists(t)&&this.requireNotExists(r);if(n){for(var s=this.datas[t],a=this.datas[r],d=0;d<s.length;d++){var g=s[d],l=g[i];h(l)?a.addAll(l):u(l)&&a.add(l),delete g[i]}e.migrationTest&&o("store "+r+" populated from the records located in the "+i+" property of the "+t+" store ("+a.length+" records)",a)}},moveRelatedIn:function(t,i,r,n,s,a){var d=this.requireExists(t)&&this.requireExists(r);if(d){for(var g=this.datas[t],l=this.datas[r],f=0,h=0;h<l.length;h++){var u=l[h],m=g.where(function(t){return T(t,i,u,n)});u[s]=a?m:m[0],f+=m.length}e.migrationTest&&o("store "+t+" moved into "+r+" to property "+s+" ("+f+" matched, "+(g.length-f)+" unmatched)",g.slice()),g.clear()}},migrate:function(t,i){var r=this.requireExists(t);if(r){var s=new n(this,t,this.stores[t],this.datas[t]);e.migrationTest&&o("store "+t+" migration start",s);var a=i.call(s,s);return e.migrationTest&&o("store "+t+" migration end",s),a}},newRecord:function(t,e){return t.$saved=v(t),t.$status=e||d.Status.Synced,t},requireExists:function(t){var i=w(this.dependents,t)!==!1;if(e.migrationTest&&o("ensuring store for "+t+" exists in "+(this.safe?"safe":"strict")+" mode",i),!this.safe&&!i)throw"A migration for "+t+" was attempted but did not exist in the dependencies array";return i},requireNotExists:function(t){var i=w(this.dependents,t)!==!1,r=0===this.datas[t].length;if(e.migrationTest&&o("ensuring store for "+t+" does not exist yet in "+(this.safe?"safe":"strict")+" mode",i&&r),!this.safe){if(!i)throw"A creation migration for "+t+" was attempted but did not exist in the dependencies array";if(!r)throw"A creation migration for "+t+" was attempted but existing data was found"}return i&&r}},n.prototype={drop:function(t){var i=m(t);return e.migrationTest&&o("dropping fields",i),this.transform(function(t){for(var e=0;e<i.length;e++)this.removeField(t,i[e])})},add:function(t,i){return c(i)?(e.migrationTest&&o("adding new field with dynamic default value: "+i),this.transform(function(e){this.setField(e,t,i(e))})):(e.migrationTest&&o("adding new field with constant default value",i),this.transform(function(e){this.setField(e,t,v(i))}))},rename:function(t,i){return e.migrationTest&&o("renaming field from "+t+" to "+i),this.transform(function(e){this.setField(e,i,e[t]),this.removeField(e,t)})},convert:function(t,i){return e.migrationTest&&o("converting field "+t+": "+i),this.transform(function(e){this.setField(e,t,i(e[t],e))})},filter:function(t){return e.migrationTest&&o("filtering records: "+t),this.transform(function(e){return!!t(e)})},setField:function(t,i,r){e.migrationTest&&(t.$saved?o("set field "+i+" to "+r+" where saved value was "+t.$saved[i]+" and stored value was "+t[i],t):o("set field "+i+" to "+r+" where stored value was "+t[i],t)),t.$saved&&(t.$saved[i]=r),t[i]=r},removeField:function(t,i){e.migrationTest&&(t.$saved?o("remove field "+i+" where saved value was "+t.$saved[i]+" and stored value was "+t[i],t):o("remove field "+i+" where stored value was "+t[i],t)),t.$saved&&delete t.$saved[i],delete t[i]},transform:function(t){var i=this.data;e.migrationTest&&o("running transform: "+t);for(var r=0;r<i.length;r++){var n=i[r];if(this.migrateRemovePending||n.$status!==d.Status.RemovePending){var s=t.call(this,n);s===!1&&(e.migrationTest&&o("removing record",n),i.splice(r--,1))}}return this}},e.load=function(i,n){function s(t){e.trigger(f.MigrationsLoaded,[t]),e.migrationTest&&o("migrations loaded",t),$=t;for(var i=0;i<t.length;i++)delete y[t[i]];e.migrationTest&&o("migrations being ran",y);for(var r in y)for(var n=M[y[r]],s=n.dependencies,d=0;d<s.length;d++)A[s[d]]=!0;for(var l in A)l in e.classes?R[l]=e.classes[l].Database.store:R[l]=e.store({name:l}),b[l]=new g,N++;for(var l in R){var h=a(l);R[l].all(h,h)}}function a(t){return function(i){h(i)&&b[t].reset(i),e.migrationTest&&o("store loaded",b[t]),++S===N&&d()}}function d(){for(var i=0;i<M.length;i++){var n=M[i];if(n.name in y){var s=new r(n.name,n.dependencies,R,b);e.migrationTest&&o("running migration "+n.name,s),n.migrate(s,b),e.trigger(f.MigrationRan,[n.name,s])}}if(e.migrationTest){var a=t.console;if(a&&a.log)for(var d=a.log,g=Function.prototype.call,i=0;i<x.length;i++)x[i].unshift(a),g.apply(d,x[i]);e.trigger(f.MigrationsTested,[x]),c()}else{for(var l in R){var h=R[l],m=b[l],v=[],w=e.classes[l];if(w){for(var T=w.Database,F=0;F<m.length;F++)v[F]=T.buildKeyFromInput(m[F]);h.reset(v,m,u,u)}else 0===m.length?h.reset(v,m,u,u):(e.trigger(f.MigrationClassNotFound,[l,h,m]),u())}for(var E in y)q.put(E,E,p,p);e.trigger(f.MigrationsSaved,[y])}}function u(){++L===N&&(e.trigger(f.MigrationsFinished,[]),c())}function m(){e.trigger(f.MigrationsNotLoaded,[]),c()}function c(){for(var t=0;t<T.length;t++)T[t].loadBegin(v)}function v(t,e){if(E.push(t),F.push(e),F.length===T.length){for(var i=0;i<F.length;i++){var e=F[i],t=E[i];t&&e.loadFinish()}w.reset().resolve()}}var w=e.loadPromise=new l(null,!1),T=e.unloaded.slice(),F=[],E=[];w.success(i,n||this),e.unloaded.length=0;var q=e.store({name:e.migrationStore}),$=[],R={},b={},A={},N=0,S=0,L=0;return q.all(s,m),w};var M=[],y={},x=[];f.MigrationsLoaded="migrations-loaded",f.MigrationRan="migration-ran",f.MigrationClassNotFound="migration-class-not-found",f.MigrationsSaved="migrations-saved",f.MigrationsTested="migrations-tested",f.MigrationsNotLoaded="migrations-not-loaded",f.MigrationsFinished="migrations-finished",e.migrationTest=!1,e.migrationStore="migrations",e.migration=s,e.migrationsClear=a,e.migrationLogs=x,e.Migrations=M,e.ApplicationMigrator=r,e.ModelMigrator=n}(this,Rekord);
//# sourceMappingURL=rekord-migrations.min.js.map
