!function(t,i,e){function n(t,i,e,n){this.name=t,this.dependents=i,this.stores=e,this.datas=n,this.safe=!1}function s(t,i,e,n){this.app=t,this.name=i,this.store=e,this.data=n,this.migrateRemovePending=!1}function r(t,i,e){var n={name:t,dependencies:i,migrate:e};x[t]=w.length,w.push(n)}function a(){x={},w.length=0}var o=i.Model,d=i.Collection,h=i.Promise,u=i.Events,f=i.isArray,l=i.isObject,g=i.toArray,c=i.isFunction,m=(i.isEmpty,i.copy),v=i.noop,p=i.indexOf,M=i.propsMatch;n.prototype={create:function(t,i){this.requireNotExists(t),this.datas[t]=new d(i())},drop:function(t){this.requireExists(t),t in this.datas&&this.datas[t].clear()},rename:function(t,i){this.requireExists(t),this.requireNotExists(i),t in this.datas&&(this.datas[i]=this.datas[t],this.datas[t]=new d)},moveRelatedOut:function(t,i,e){this.requireExists(t),this.requireNotExists(e);for(var n=this.datas[t],s=this.datas[e],r=0;r<n.length;r++){var a=n[r],o=a[i];f(o)?s.addAll(o):l(o)&&s.add(o),delete a[i]}},moveRelatedIn:function(t,i,e,n,s,r){this.requireExists(t),this.requireExists(e);for(var a=this.datas[t],o=this.datas[e],d=0;d<o.length;d++){var h=o[d],u=a.where(function(t){return M(t,i,h,n)});h[s]=r?u:u[0]}a.clear()},migrate:function(t,i){if(this.requireExists(t),t in this.stores){var e=new s(this,t,this.stores[t],this.datas[t]);return i.call(e,e)}},newRecord:function(t,i){return t.$saved=m(t),t.$status=i||o.Status.Synced,t},requireExists:function(t){if(!this.safe){if(p(this.dependents,t)===!1)throw"A migration for "+t+" was attempted but did not exist in the dependencies array";if(!(t in this.stores))throw"A migration for "+t+" was attempted but does not exist locally (or was not defined)"}},requireNotExists:function(t){if(!this.safe&&p(this.dependents,t)===!1)throw"A creation migration for "+t+" was attempted but did not exist in the dependencies array"}},s.prototype={drop:function(t){var i=g(t);return this.transform(function(t){for(var e=0;e<i.length;e++)this.removeField(t,i[e])})},add:function(t,i){return c(i)?this.transform(function(e){this.setField(e,t,i(e))}):this.transform(function(e){this.setField(e,t,m(i))})},rename:function(t,i){return this.transform(function(e){this.setField(e,i,e[t]),this.removeField(e,t)})},convert:function(t,i){return this.transform(function(e){this.setField(e,t,i(e[t],e))})},filter:function(t){return this.transform(function(i){return!!t(i)})},setField:function(t,i,e){t.$saved&&(t.$saved[i]=e),t[i]=e},removeField:function(t,i){t.$saved&&delete t.$saved[i],delete t[i]},transform:function(t){for(var i=this.data,e=0;e<i.length;e++){var n=i[e];if(this.migrateRemovePending||n.$status!==o.Status.RemovePending){var s=t.call(this,n);s===!1&&i.splice(e--,1)}}return this}},i.load=function(e,s){function r(t){i.trigger(u.MigrationsLoaded,[t]),R=t;for(var e=0;e<t.length;e++)delete x[t[e]];for(var n in x)for(var s=w[x[n]],r=s.dependencies,o=0;o<r.length;o++)A[r[o]]=!0;for(var h in A)h in i.classes?N[h]=i.classes[h].Database.store:N[h]=i.store({name:h}),b[h]=new d,S++;for(var h in N){var f=a(h);N[h].all(f,f)}}function a(t){return function(i){f(i)&&b[t].reset(i),++$===S&&o()}}function o(){for(var e=0;e<w.length;e++){var s=w[e];if(s.name in x){var r=new n(s.name,s.dependencies,N,b);s.migrate(r,b),i.trigger(u.MigrationRan,[s.name,r])}}if(i.migrationTest)t.console&&t.console.log&&t.console.log(F),i.trigger(u.MigrationsTested,[F]);else{for(var a in N){var o=N[a],d=b[a],h=[],f=i.classes[a];if(f){for(var g=f.Database,c=0;c<d.length;c++)h[c]=g.buildKeyFromInput(d[c]);o.reset(h,d,l,l)}else 0===d.length?o.reset(h,d,l,l):(i.trigger(u.MigrationClassNotFound,[a,o,d]),l())}for(var m in x)y.put(m,m,v,v);i.trigger(u.MigrationsSaved,[x])}}function l(){++P===S&&(i.trigger(u.MigrationsFinished,[]),c())}function g(){i.trigger(u.MigrationsNotLoaded,[]),c()}function c(){for(var t=0;t<M.length;t++)M[t].loadBegin(m)}function m(t,i){if(q.push(t),E.push(i),E.length===M.length){for(var e=0;e<E.length;e++){var i=E[e],t=q[e];t&&i.loadFinish()}p.reset().resolve()}}var p=i.loadPromise=i.loadPromise||new h(null,!1),M=i.unloaded.slice(),E=[],q=[];p.success(e,s||this),i.unloaded.length=0;var y=i.store({name:i.migrationStore}),R=[],N={},b={},A={},S=0,$=0,P=0;return y.all(r,g),p};var w=[],x={},F=[];u.MigrationsLoaded="migrations-loaded",u.MigrationRan="migration-ran",u.MigrationClassNotFound="migration-class-not-found",u.MigrationsSaved="migrations-saved",u.MigrationsTested="migrations-tested",u.MigrationsNotLoaded="migrations-not-loaded",u.MigrationsFinished="migrations-finished",i.migrationTest=!1,i.migrationStore="migrations",i.migration=r,i.migrationsClear=a,i.Migrations=w,i.ApplicationMigrator=n,i.ModelMigrator=s}(this,Rekord);
//# sourceMappingURL=rekord-migrations.min.js.map
